<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat P2P - Full Mesh</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #222;
        color: #eee;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }
      .container {
        max-width: 600px;
        width: 95%;
        margin-top: 20px;
      }
      h1 {
        color: #4facfe;
        text-align: center;
      }
      .panel {
        background: #333;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }
      .hidden {
        display: none;
      }
      input {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border-radius: 4px;
        border: none;
        box-sizing: border-box;
      }
      button {
        width: 100%;
        padding: 12px;
        background: #4facfe;
        border: none;
        font-weight: bold;
        cursor: pointer;
        border-radius: 4px;
        color: #fff;
        transition: 0.2s;
      }
      button:hover {
        background: #00f2fe;
      }
      #messages {
        height: 350px;
        overflow-y: auto;
        background: #1a1a1a;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
        border: 1px solid #444;
      }
      .msg {
        margin-bottom: 8px;
        padding: 6px 10px;
        border-radius: 4px;
        background: #444;
        word-wrap: break-word;
      }
      .msg.system {
        color: #888;
        font-style: italic;
        font-size: 0.8em;
        text-align: center;
        background: transparent;
      }
      .msg.me {
        background: #005c4b;
        text-align: right;
        align-self: flex-end;
      }
      #qrcode {
        display: flex;
        justify-content: center;
        margin: 20px 0;
        background: white;
        padding: 10px;
        border-radius: 4px;
      }
      .badge {
        background: #555;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8em;
        margin-left: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>
        üï∏Ô∏è P2P Mesh Chat <span id="peer-count" class="badge">0 Online</span>
      </h1>

      <div id="login" class="panel">
        <h3>Entrar na Rede</h3>
        <input type="text" id="username" placeholder="Seu Apelido (Ex: Ana)" />
        <button onclick="initApp()">Conectar</button>
      </div>

      <div id="lobby" class="panel hidden">
        <p style="text-align: center; color: #aaa">
          Compartilhe para outros entrarem:
        </p>
        <div id="qrcode"></div>
        <p
          id="my-id"
          style="font-size: 0.7em; text-align: center; word-break: break-all"
        ></p>
        <button
          onclick="enterChat()"
          style="background: #444; margin-top: 10px"
        >
          Ocultar QR Code e ir pro Chat
        </button>
      </div>

      <div id="chat" class="panel hidden">
        <div id="messages"></div>
        <div style="display: flex; gap: 10px">
          <input type="text" id="msgInput" placeholder="Mensagem..." />
          <button onclick="sendUserMessage()" style="width: 80px">
            Enviar
          </button>
        </div>
        <button
          onclick="showLobby()"
          style="
            background: transparent;
            color: #888;
            font-size: 0.8em;
            margin-top: 5px;
          "
        >
          Mostrar QR Code novamente
        </button>
      </div>
    </div>

    <script>
      let peer
      let myName
      let connections = {} // Armazena conex√µes por ID: { 'peer_id': conn_object }
      const urlParams = new URLSearchParams(window.location.search)
      const seedId = urlParams.get("seed") // ID do "anfitri√£o" inicial

      function initApp() {
        myName = document.getElementById("username").value
        if (!myName) return alert("Digite um nome!")

        document.getElementById("login").classList.add("hidden")
        document.getElementById(
          "messages"
        ).innerHTML += `<div class="msg system">Iniciando n√≥ P2P...</div>`
        document.getElementById("chat").classList.remove("hidden")

        peer = new Peer() // Cria ID aleat√≥rio

        peer.on("open", (id) => {
          console.log("Meu ID:", id)
          document.getElementById("my-id").innerText = `ID: ${id}`

          // Se eu n√£o entrei por link de ningu√©m, eu sou o SEED (Semente/Primeiro)
          if (!seedId) {
            generateQRCode(id)
            document.getElementById("chat").classList.add("hidden")
            document.getElementById("lobby").classList.remove("hidden")
            log("Voc√™ criou a rede. Aguardando peers...", "system")
          } else {
            // Se entrei por link, conecto no SEED para pedir entrada
            log("Conectando ao n√≥ inicial...", "system")
            connectToPeer(seedId)
          }
        })

        // Quando algu√©m conecta em mim
        peer.on("connection", (conn) => {
          setupConnection(conn)
        })

        peer.on("error", (err) => console.error(err))
      }

      function connectToPeer(peerId) {
        if (connections[peerId]) return // J√° conectado
        if (peerId === peer.id) return // N√£o conectar em si mesmo

        const conn = peer.connect(peerId, {
          metadata: { name: myName }, // Mando meu nome junto
        })

        conn.on("open", () => setupConnection(conn))
      }

      function setupConnection(conn) {
        // Se j√° tenho essa conex√£o, ignoro para n√£o duplicar
        if (connections[conn.peer]) return

        connections[conn.peer] = conn
        updateCount()

        conn.on("data", (data) => handleData(data, conn))
        conn.on("close", () => {
          log(`${conn.metadata.name || "Algu√©m"} saiu.`, "system")
          delete connections[conn.peer]
          updateCount()
        })

        // Se eu sou o SEED e algu√©m conectou, mando a lista de quem mais t√° aqui
        // Isso √© o pulo do gato para formar o MESH
        if (!seedId || Object.keys(connections).length > 1) {
          const peersToShare = Object.keys(connections).filter(
            (id) => id !== conn.peer
          )
          if (peersToShare.length > 0) {
            conn.send({
              type: "peer-list",
              peers: peersToShare,
            })
          }
        }
      }

      function handleData(data, senderConn) {
        // Atualiza o nome do peer se vier no payload (primeira conex√£o as vezes delay)
        if (!senderConn.metadata.name && data.senderName) {
          senderConn.metadata.name = data.senderName
        }

        if (data.type === "chat") {
          log(`<strong>${data.senderName}:</strong> ${data.msg}`)
        } else if (data.type === "peer-list") {
          // Recebi uma lista de IPs para conectar (L√≥gica Mesh)
          console.log("Recebi lista de peers:", data.peers)
          data.peers.forEach((otherPeerId) => {
            connectToPeer(otherPeerId)
          })
        }
      }

      function sendUserMessage() {
        const txt = document.getElementById("msgInput").value
        if (!txt) return

        log(`<strong>Voc√™:</strong> ${txt}`, "me")

        // Envia para TODOS os conectados (Broadcast Mesh)
        Object.values(connections).forEach((conn) => {
          conn.send({
            type: "chat",
            senderName: myName,
            msg: txt,
          })
        })

        document.getElementById("msgInput").value = ""
      }

      // Fun√ß√µes de Interface
      function log(html, type = "") {
        const box = document.getElementById("messages")
        box.innerHTML += `<div class="msg ${type}">${html}</div>`
        box.scrollTop = box.scrollHeight
      }

      function updateCount() {
        const count = Object.keys(connections).length
        document.getElementById(
          "peer-count"
        ).innerText = `${count} Peers Conectados`
      }

      function generateQRCode(id) {
        const url = `${window.location.href.split("?")[0]}?seed=${id}`
        new QRCode(document.getElementById("qrcode"), {
          text: url,
          width: 150,
          height: 150,
        })
      }

      function enterChat() {
        document.getElementById("lobby").classList.add("hidden")
        document.getElementById("chat").classList.remove("hidden")
      }

      function showLobby() {
        document.getElementById("chat").classList.add("hidden")
        document.getElementById("lobby").classList.remove("hidden")
      }
    </script>
  </body>
</html>
