<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat P2P - Full Mesh</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #222;
        color: #eee;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }
      .container {
        max-width: 600px;
        width: 95%;
        margin-top: 20px;
      }
      h1 {
        color: #4facfe;
        text-align: center;
      }
      .panel {
        background: #333;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }
      .hidden {
        display: none;
      }
      input {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border-radius: 4px;
        border: none;
        box-sizing: border-box;
      }
      button {
        width: 100%;
        padding: 12px;
        background: #4facfe;
        border: none;
        font-weight: bold;
        cursor: pointer;
        border-radius: 4px;
        color: #fff;
        transition: 0.2s;
      }
      button:hover {
        background: #00f2fe;
      }
      #messages {
        height: 350px;
        overflow-y: auto;
        background: #1a1a1a;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
        border: 1px solid #444;
      }
      .msg {
        margin-bottom: 8px;
        padding: 6px 10px;
        border-radius: 4px;
        background: #444;
        word-wrap: break-word;
      }
      .msg.system {
        color: #888;
        font-style: italic;
        font-size: 0.8em;
        text-align: center;
        background: transparent;
      }
      .msg.me {
        background: #005c4b;
        text-align: right;
        align-self: flex-end;
      }
      #qrcode {
        display: flex;
        justify-content: center;
        margin: 20px 0;
        background: white;
        padding: 10px;
        border-radius: 4px;
      }
      .badge {
        background: #555;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8em;
        margin-left: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>
        üï∏Ô∏è P2P Mesh Chat <span id="peer-count" class="badge">0 Online</span>
      </h1>

      <div id="login" class="panel">
        <h3>Entrar na Rede</h3>
        <input type="text" id="username" placeholder="Seu Apelido (Ex: Ana)" />
        <button onclick="initApp()">Conectar</button>
      </div>

      <div id="lobby" class="panel hidden">
        <p style="text-align: center; color: #aaa">
          Compartilhe para outros entrarem:
        </p>
        <div id="qrcode"></div>
        <p
          id="my-id"
          style="font-size: 0.7em; text-align: center; word-break: break-all"
        ></p>
        <button
          onclick="enterChat()"
          style="background: #444; margin-top: 10px"
        >
          Ocultar QR Code e ir pro Chat
        </button>
      </div>

      <div id="chat" class="panel hidden">
        <div id="messages"></div>
        <div style="display: flex; gap: 10px">
          <input type="text" id="msgInput" placeholder="Mensagem..." />
          <button onclick="sendUserMessage()" style="width: 80px">
            Enviar
          </button>
        </div>
        <button
          onclick="showLobby()"
          style="
            background: transparent;
            color: #888;
            font-size: 0.8em;
            margin-top: 5px;
          "
        >
          Mostrar QR Code novamente
        </button>
      </div>
    </div>

    <script>
      let peer
      let myName
      let connections = {} // Lista de conex√µes
      // Gera um ID √∫nico para cada mensagem para evitar duplicatas (caso a malha funcione parcialmente)
      let processedMessageIds = new Set()

      const urlParams = new URLSearchParams(window.location.search)
      const hostId = urlParams.get("seed") // Se tiver ID na URL, √© cliente. Se n√£o, √© Host.

      function initApp() {
        myName = document.getElementById("username").value
        if (!myName) return alert("Digite um nome!")

        document.getElementById("login").classList.add("hidden")
        document.getElementById(
          "messages"
        ).innerHTML += `<div class="msg system">Iniciando n√≥ P2P...</div>`
        document.getElementById("chat").classList.remove("hidden")

        // Configura√ß√£o com servidores STUN p√∫blicos para ajudar na conex√£o
        peer = new Peer({
          config: {
            iceServers: [
              { urls: "stun:stun.l.google.com:19302" },
              { urls: "stun:global.stun.twilio.com:3478" },
            ],
          },
        })

        peer.on("open", (id) => {
          console.log("Meu ID:", id)
          document.getElementById("my-id").innerText = `ID: ${id}`

          if (!hostId) {
            // SOU O HOST (SUPERNO)
            generateQRCode(id)
            document.getElementById("chat").classList.add("hidden")
            document.getElementById("lobby").classList.remove("hidden")
            log("Sala criada. Aguardando peers...", "system")
          } else {
            // SOU CLIENTE
            log("Conectando ao Supern√≥...", "system")
            connectToHost(hostId)
          }
        })

        peer.on("connection", (conn) => {
          setupConnection(conn)
        })

        peer.on("error", (err) => console.error(err))
      }

      function connectToHost(id) {
        const conn = peer.connect(id, { metadata: { name: myName } })
        conn.on("open", () => setupConnection(conn))
        conn.on("error", (err) => log("Erro na conex√£o: " + err, "system"))
      }

      function setupConnection(conn) {
        if (connections[conn.peer]) return

        connections[conn.peer] = conn
        updateCount()

        conn.on("data", (data) => handleData(data, conn))
        conn.on("close", () => {
          log(`${conn.metadata.name || "Algu√©m"} saiu.`, "system")
          delete connections[conn.peer]
          updateCount()
        })
      }

      function handleData(data, senderConn) {
        // 1. Evita processar a mesma mensagem duas vezes
        if (processedMessageIds.has(data.id)) return
        processedMessageIds.add(data.id)

        // 2. Atualiza nome se necess√°rio
        if (data.senderName && senderConn && !senderConn.metadata.name) {
          senderConn.metadata.name = data.senderName
        }

        // 3. Exibe a mensagem
        if (data.type === "chat") {
          log(`<strong>${data.senderName}:</strong> ${data.msg}`)

          // 4. L√ìGICA DO SUPERN√ì (RELAY)
          // Se eu sou o Host (!hostId), eu retransmito a mensagem para todos, MENOS para quem mandou
          if (!hostId) {
            broadcast(data, senderConn.peer)
          }
        }
      }

      function sendUserMessage() {
        const txt = document.getElementById("msgInput").value
        if (!txt) return

        // Cria um ID √∫nico para a mensagem (Timestamp + Random)
        const msgId = Date.now() + Math.random().toString(36).substr(2, 9)
        const payload = {
          type: "chat",
          id: msgId,
          senderName: myName,
          msg: txt,
        }

        log(`<strong>Voc√™:</strong> ${txt}`, "me")
        processedMessageIds.add(msgId) // J√° marco que eu vi minha pr√≥pria mensagem

        // Manda para quem estiver conectado (Se sou Host, mando pra todos. Se sou Cliente, mando pro Host)
        broadcast(payload)

        document.getElementById("msgInput").value = ""
      }

      function broadcast(data, excludeId = null) {
        Object.values(connections).forEach((conn) => {
          if (conn.peer !== excludeId) {
            conn.send(data)
          }
        })
      }

      // Fun√ß√µes visuais (sem altera√ß√£o)
      function log(html, type = "") {
        const box = document.getElementById("messages")
        box.innerHTML += `<div class="msg ${type}">${html}</div>`
        box.scrollTop = box.scrollHeight
      }
      function updateCount() {
        const count = Object.keys(connections).length
        document.getElementById("peer-count").innerText = `${count} Peers`
      }
      function generateQRCode(id) {
        const url = `${window.location.href.split("?")[0]}?seed=${id}`
        new QRCode(document.getElementById("qrcode"), {
          text: url,
          width: 150,
          height: 150,
        })
      }
      function enterChat() {
        document.getElementById("lobby").classList.add("hidden")
        document.getElementById("chat").classList.remove("hidden")
      }
      function showLobby() {
        document.getElementById("chat").classList.add("hidden")
        document.getElementById("lobby").classList.remove("hidden")
      }
    </script>
  </body>
</html>
