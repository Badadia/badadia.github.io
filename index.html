<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>P2P Chat - Apresenta√ß√£o</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
      body {
        font-family: "Courier New", monospace;
        background: #121212;
        color: #0f0;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 10px;
      }
      .container {
        max-width: 600px;
        width: 100%;
      }
      h1 {
        text-align: center;
        border-bottom: 1px solid #0f0;
        padding-bottom: 10px;
        font-size: 1.5rem;
      }

      .panel {
        background: #1a1a1a;
        padding: 15px;
        border: 1px solid #333;
        margin-bottom: 15px;
        border-radius: 5px;
      }
      .hidden {
        display: none !important;
      }

      input {
        width: 100%;
        padding: 12px;
        background: #000;
        border: 1px solid #0f0;
        color: #fff;
        box-sizing: border-box;
        font-family: inherit;
        margin-bottom: 10px;
      }
      button {
        width: 100%;
        padding: 12px;
        background: #0f0;
        color: #000;
        border: none;
        font-weight: bold;
        cursor: pointer;
        text-transform: uppercase;
      }
      button:hover {
        background: #0c0;
      }

      #chat-box {
        height: 350px;
        overflow-y: auto;
        border: 1px solid #333;
        padding: 10px;
        background: #000;
        margin-bottom: 10px;
        font-size: 0.9rem;
      }
      .msg {
        margin-bottom: 5px;
        word-break: break-word;
      }
      .msg.me {
        color: #888;
        text-align: right;
      }
      .msg.sys {
        color: #ff0;
        font-style: italic;
        font-size: 0.8rem;
        text-align: center;
        margin: 10px 0;
      }
      .msg.host {
        color: #0ff;
        font-weight: bold;
      }

      #qrcode {
        background: white;
        padding: 10px;
        display: inline-block;
        margin: 10px 0;
      }
      #debug-log {
        font-size: 0.7em;
        color: #444;
        height: 60px;
        overflow-y: auto;
        border-top: 1px dashed #333;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üì° REDE P2P H√çBRIDA</h1>

      <div id="login" class="panel">
        <p>IDENTIFICA√á√ÉO DO N√ì:</p>
        <input type="text" id="username" placeholder="Seu Nome..." />
        <button onclick="startSystem()">CONECTAR √Ä REDE</button>
      </div>

      <div id="host-panel" class="panel hidden" style="text-align: center">
        <p style="color: #0ff">MODO SUPERNO (HOST) ATIVO</p>
        <div id="qrcode"></div>
        <p style="font-size: 0.8em">
          Peers Online: <span id="peer-count">0</span>
        </p>
        <button onclick="goToChat()">IR PARA O CHAT</button>
      </div>

      <div id="chat-panel" class="panel hidden">
        <div
          id="status-bar"
          style="font-size: 0.8em; color: #666; margin-bottom: 5px"
        >
          Conectado como Cliente
        </div>
        <div id="chat-box"></div>
        <div style="display: flex; gap: 10px">
          <input
            type="text"
            id="msgInput"
            placeholder="Digite sua mensagem..."
          />
          <button onclick="sendMessage()" style="width: auto">Enviar</button>
        </div>
        <button
          onclick="showHostPanel()"
          id="back-btn"
          class="hidden"
          style="
            background: #333;
            color: #fff;
            margin-top: 10px;
            font-size: 0.8em;
          "
        >
          Ver QR Code
        </button>
      </div>

      <div id="debug-log">Logs do Sistema...</div>
    </div>

    <script>
      // --- CONFIGURA√á√ÉO ---
      const PEER_CONFIG = {
        debug: 1,
        config: {
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:global.stun.twilio.com:3478" },
          ],
        },
      }

      let peer = null
      let myName = "An√¥nimo"
      let connections = {}

      const urlParams = new URLSearchParams(window.location.search)
      const hostId = urlParams.get("host")
      const isHost = !hostId

      // --- SISTEMA ---
      function startSystem() {
        myName = document.getElementById("username").value
        if (!myName) return alert("Por favor, digite um nome.")

        document.getElementById("login").classList.add("hidden")

        peer = new Peer(PEER_CONFIG)

        peer.on("open", (id) => {
          logDebug(`Meu Peer ID: ${id}`)

          if (isHost) {
            setupHostUI(id)
            document.getElementById("status-bar").innerText =
              "Status: SUPERNO (HOST)"
          } else {
            connectToHost(hostId)
          }
          startHeartbeat()
        })

        peer.on("connection", (conn) => {
          if (isHost) handleConnection(conn)
        })

        peer.on("error", (err) => logDebug(`Erro: ${err.type}`))
      }

      // --- HOST UI ---
      function setupHostUI(id) {
        document.getElementById("host-panel").classList.remove("hidden")
        document.getElementById("back-btn").classList.remove("hidden")

        const url = `${window.location.href.split("?")[0]}?host=${id}`
        new QRCode(document.getElementById("qrcode"), {
          text: url,
          width: 160,
          height: 160,
        })
      }

      // --- CONEX√ÉO ---
      function connectToHost(targetId) {
        document.getElementById("chat-panel").classList.remove("hidden")
        logDebug("Conectando ao Host...")

        const conn = peer.connect(targetId, {
          metadata: { name: myName },
          serialization: "json",
        })

        handleConnection(conn)
      }

      function handleConnection(conn) {
        conn.on("open", () => {
          logDebug(`Conex√£o aberta: ${conn.metadata.name || conn.peer}`)
          connections[conn.peer] = conn
          updateCount()

          if (isHost) {
            const joinMsg = {
              type: "sys",
              msg: `${conn.metadata.name || "Novo peer"} entrou na rede.`,
            }
            broadcast(joinMsg)
            addMsg(joinMsg.msg, "sys")
          }
        })

        conn.on("data", (data) => {
          if (data.type === "ping") return

          if (data.type === "sys") {
            addMsg(data.msg, "sys")
          } else if (data.type === "chat") {
            addMsg(`${data.name}: ${data.msg}`)
            if (isHost) broadcast(data, conn.peer)
          }
        })

        conn.on("close", () => {
          handleDisconnect(conn)
        })

        conn.on("error", () => handleDisconnect(conn))
      }

      function handleDisconnect(conn) {
        logDebug(`Conex√£o perdida com: ${conn.peer}`)
        delete connections[conn.peer]
        updateCount()

        if (isHost) {
          const exitMsg = {
            type: "sys",
            msg: `${conn.metadata.name || "Um peer"} desconectou.`,
          }
          broadcast(exitMsg)
          addMsg(exitMsg.msg, "sys")
        } else {
          if (Object.keys(connections).length === 0) {
            addMsg("‚ö†Ô∏è O SUPERN√ì CAIU. A REDE FOI DESFEITA.", "err")
            document.getElementById("msgInput").disabled = true
            document.getElementById("status-bar").innerText =
              "Status: DESCONECTADO (HOST OFFLINE)"
            document.getElementById("status-bar").style.color = "red"
            alert("O Host encerrou a sess√£o. A rede P2P foi finalizada.")
          }
        }
      }

      // --- HEARTBEAT (Mant√©m 4G vivo) ---
      function startHeartbeat() {
        setInterval(() => {
          Object.values(connections).forEach((conn) => {
            if (conn.open) {
              conn.send({ type: "ping" })
            }
          })
        }, 5000)
      }

      // --- CHAT ---
      function sendMessage() {
        const input = document.getElementById("msgInput")
        const txt = input.value
        if (!txt) return

        const payload = { type: "chat", name: myName, msg: txt }
        addMsg(`Voc√™: ${txt}`, "me")

        if (isHost) {
          broadcast(payload)
        } else {
          const hostConn = Object.values(connections)[0]
          if (hostConn && hostConn.open) hostConn.send(payload)
        }
        input.value = ""
      }

      function broadcast(data, excludeId = null) {
        Object.values(connections).forEach((conn) => {
          if (conn.peer !== excludeId && conn.open) {
            conn.send(data)
          }
        })
      }

      function addMsg(text, type = "") {
        const box = document.getElementById("chat-box")
        const div = document.createElement("div")
        div.className = `msg ${type}`
        div.innerText = text
        box.appendChild(div)
        box.scrollTop = box.scrollHeight
      }

      function logDebug(txt) {
        const log = document.getElementById("debug-log")
        log.innerHTML = `> ${txt}<br>` + log.innerHTML
      }

      function updateCount() {
        if (isHost)
          document.getElementById("peer-count").innerText =
            Object.keys(connections).length
      }

      function goToChat() {
        document.getElementById("host-panel").classList.add("hidden")
        document.getElementById("chat-panel").classList.remove("hidden")
      }

      function showHostPanel() {
        document.getElementById("chat-panel").classList.add("hidden")
        document.getElementById("host-panel").classList.remove("hidden")
      }

      document.getElementById("msgInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage()
      })
      window.addEventListener("beforeunload", () => {
        if (isHost) {
          broadcast({
            type: "sys",
            msg: "O Supern√≥ foi desligado. Rede encerrada.",
          })
        } else {
          const hostConn = Object.values(connections)[0]
          if (hostConn && hostConn.open) {
            hostConn.send({ type: "sys", msg: `${myName} saiu da rede.` })
          }
        }
      })
    </script>
  </body>
</html>
